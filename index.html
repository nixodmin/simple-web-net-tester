<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Raleway', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
        }
        .test-container {
            background: #2d2d2d;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid #5cdcb9;
        }
        button {
            background: #916dff;
            color: #ffffff;
            border: none;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Raleway', sans-serif;
        }
        button:hover {
            background: #7c5ce6;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(145, 109, 255, 0.3);
        }
        button:disabled {
            background: #555555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #333333;
            border-radius: 8px;
            border-left: 4px solid #5cdcb9;
        }
        .progress {
            height: 25px;
            background: #444444;
            border-radius: 12px;
            margin: 15px 0;
            overflow: hidden;
            border: 1px solid #5cdcb9;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #5cdcb9, #4ac3a1);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(92, 220, 185, 0.3);
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-weight: 500;
            color: #5cdcb9;
        }
        .results-table {
            width: 100%;
            margin-top: 20px;
        }
        .results-table td {
            padding: 10px;
            border-bottom: 1px solid #444444;
        }
        .results-table td:first-child {
            font-weight: 600;
            width: 40%;
            color: #5cdcb9;
        }
        .results-table td:last-child {
            color: #ffffff;
            font-weight: 500;
        }
        h1 {
            text-align: center;
            color: #ffffff;
            font-weight: 700;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 0 0 20px rgba(92, 220, 185, 0.3);
        }
        h2 {
            color: #5cdcb9;
            font-weight: 600;
            margin-bottom: 20px;
        }
        h3 {
            color: #5cdcb9;
            font-weight: 600;
        }
        .error {
            color: #ff6b6b;
            background: #2d1a1a;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ff6b6b;
        }
        p {
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <center><h2>Simple Web Net Tester</h2></center>
        <center><button id="runTest">–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç</button></center>

        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="status" id="status" style="display: none;"></div>

        <div class="result" id="result">
            <p>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç" –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.</p>
        </div>
    </div>

    <script>
        document.getElementById('runTest').addEventListener('click', runFullTest);

        async function runFullTest() {
            const resultDiv = document.getElementById('result');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const statusDiv = document.getElementById('status');
            const button = document.getElementById('runTest');

            button.disabled = true;
            button.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            resultDiv.innerHTML = '<p>–û–∂–∏–¥–∞–π—Ç–µ, –ø—Ä–æ–≤–æ–¥–∏–º –∏–∑–º–µ—Ä–µ–Ω–∏—è...</p>';
            progressContainer.style.display = 'block';
            statusDiv.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                // –¢–µ—Å—Ç Ping
                progressBar.style.width = '20%';
                statusDiv.textContent = '–ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø–∏–Ω–≥–∞...';
                const pingResult = await testPing();

                // –¢–µ—Å—Ç Download
                progressBar.style.width = '40%';
                statusDiv.textContent = '–ò–∑–º–µ—Ä–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏...';
                const downloadSpeed = await testDownload();

                // –¢–µ—Å—Ç Upload
                progressBar.style.width = '80%';
                statusDiv.textContent = '–ò–∑–º–µ—Ä–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–¥–∞—á–∏...';
                const uploadSpeed = await testUpload();

                // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
                progressBar.style.width = '100%';
                statusDiv.textContent = '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!';

                resultDiv.innerHTML = `
                    <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:</h3>
                    <table class="results-table">
                        <tr>
                            <td>üèì Ping (—Å—Ä–µ–¥–Ω–∏–π):</td>
                            <td>${pingResult.avgPing.toFixed(1)} –º—Å</td>
                        </tr>
                        <tr>
                            <td>üìà –î–∂–∏—Ç—Ç–µ—Ä:</td>
                            <td>${pingResult.jitter.toFixed(1)} –º—Å</td>
                        </tr>
                        <tr>
                            <td>‚¨áÔ∏è –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏:</td>
                            <td>${downloadSpeed.toFixed(2)} –ú–±–∏—Ç/—Å</td>
                        </tr>
                        <tr>
                            <td>‚¨ÜÔ∏è –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–¥–∞—á–∏:</td>
                            <td>${uploadSpeed.toFixed(2)} –ú–±–∏—Ç/—Å</td>
                        </tr>
                    </table>
                `;

            } catch (error) {
                console.error('Test error:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                progressBar.style.backgroundColor = '#d32f2f';
                statusDiv.textContent = '–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞';
            } finally {
                button.disabled = false;
                button.textContent = '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç';
            }
        }

        async function testPing() {
            const pingTimes = [];
            let totalJitter = 0;

            for (let i = 0; i < 5; i++) {
                const start = performance.now();
                try {
                    const response = await fetch('/speedtest/ping?t=' + Date.now());
                    if (!response.ok) throw new Error('Ping failed');
                    await response.json();
                } catch (error) {
                    throw new Error('Ping test failed: ' + error.message);
                }
                const ping = performance.now() - start;
                pingTimes.push(ping);

                if (i > 0) {
                    totalJitter += Math.abs(ping - pingTimes[i-1]);
                }

                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–∏–Ω–≥–∞–º–∏
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            const avgPing = pingTimes.reduce((a, b) => a + b, 0) / pingTimes.length;
            const jitter = totalJitter / (pingTimes.length - 1);

            return { avgPing, jitter };
        }

        async function testDownload() {
            const startTime = performance.now();
            let totalBytes = 0;

            try {
                const response = await fetch('/speedtest/download?t=' + Date.now());
                if (!response.ok) throw new Error('Download test failed');

                const reader = response.body.getReader();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    totalBytes += value.length;

                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
                    if ((performance.now() - startTime) > 10000) {
                        reader.cancel();
                        break;
                    }
                }

            } catch (error) {
                throw new Error('Download test failed: ' + error.message);
            }

            const duration = (performance.now() - startTime) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            const speedMbps = (totalBytes * 8) / (1000 * 1000) / duration; // –∏—Å–ø–æ–ª—å–∑—É–µ–º 1000, –∞ –Ω–µ 1024 –¥–ª—è –ú–±–∏—Ç/—Å
            return Math.max(speedMbps, 0);
        }

        async function testUpload() {
            const testDuration = 10; // —Å–µ–∫—É–Ω–¥
            const chunkSize = 1024 * 1024; // 1MB –±–ª–æ–∫–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏

            // –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π –±–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö
            const chunk = new Uint8Array(chunkSize);
            for (let i = 0; i < chunkSize; i++) {
                chunk[i] = Math.floor(Math.random() * 256);
            }

            const startTime = performance.now();
            let totalBytesSent = 0;

            try {
                // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –±–ª–æ–∫–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const chunks = [];
                const targetBytes = 100 * 1024 * 1024; // –¶–µ–ª–µ–≤–æ–π –æ–±—ä–µ–º ~100MB

                while (totalBytesSent < targetBytes) {
                    chunks.push(chunk);
                    totalBytesSent += chunkSize;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è
                    if ((performance.now() - startTime) / 1000 >= testDuration) {
                        break;
                    }
                }

                // –°–æ–∑–¥–∞–µ–º Blob –∏–∑ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤
                const blob = new Blob(chunks, { type: 'application/octet-stream' });

                const response = await fetch('/speedtest/upload?t=' + Date.now(), {
                    method: 'POST',
                    body: blob,
                    headers: {
                        'Content-Type': 'application/octet-stream',
                        'Content-Length': blob.size.toString()
                    }
                });

                if (!response.ok) throw new Error('Upload test failed');

                const result = await response.json();
                const actualDuration = (performance.now() - startTime) / 1000;

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                const bytesReceived = result.total_bytes;
                const speedMbps = (bytesReceived * 8) / (1000 * 1000) / result.duration_sec;

                console.log(`Upload: ${bytesReceived} bytes in ${result.duration_sec}s = ${speedMbps.toFixed(2)} Mbps`);
                return Math.max(speedMbps, 0);

            } catch (error) {
                throw new Error('Upload test failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
